<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" sizes="32x32" href="icon.png">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-table.css" type="text/css">
    <script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script src="layui/layui.js"></script>
    <script src="js/bootstrap-table.js" type="text/javascript"></script>
    <script src="js/bootstrap-table-zh-CN.js" type="text/javascript"></script>
    <title>e-butler</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        /* å·¦ä¾§å¯¼èˆªæ æ ·å¼ */
        .navbar {
            width: 200px;
            background-color: #f9f9f9;
            border-right: 1px solid #ddd;
            position: fixed;
            height: 100%;
            overflow: auto;
            padding-top: 20px;
            transition: all 0.3s ease;
            transform: translateX(0);
        }
        .navbar.collapsed {
            transform: translateX(-200px);
        }
        .navbar a {
            display: block;
            color: #000;
            padding: 10px 16px;
            text-decoration: none;
        }
        .navbar a:hover {
            background-color: #ddd;
        }

        /* å³ä¾§å†…å®¹åŒºæ ·å¼ */
        .content {
            margin-left: 200px; /* ä¸å·¦ä¾§å¯¼èˆªæ å®½åº¦ä¸€è‡´ */
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        .content.collapsed {
            margin-left: 0;
        }
        .model-card {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container mt-4">

</div>
<!-- å·¦ä¾§å¯¼èˆªæ  -->
<div class="navbar" id="navbar">
    <a href="site.html" class="glyphicon glyphicon-cloud">&nbsp;ç«™ç‚¹ç®¡ç†</a>
    <a href="line.html" class="glyphicon glyphicon-random">&nbsp;çº¿è·¯ç®¡ç†</a>
    <a href="index.html" class="glyphicon glyphicon-user">&nbsp;å®¢æˆ·ç®¡ç†</a>
    <a href="upload.html" class="glyphicon glyphicon-cloud-upload">&nbsp;æ–‡ä»¶ä¸Šä¼ </a>
</div>

<!-- å³ä¾§å†…å®¹åŒº -->
<div class="container mt-4" id="content">
    <div class="row" style="margin: 0 3rem;padding:15px;">
        <form class="form-inline">
            <div id="btn-add" class="btn btn-primary" onclick="showModify()">æ–°å¢çº¿è·¯</div>
            <div class="form-group">
                <label class="sr-only" for="search">æœç´¢</label>
                <input type="text" class="form-control" id="search" placeholder="æœç´¢ğŸ”">
            </div>
        </form>
    </div>
    <!--    <div class="row" style="margin: 0 3rem;">-->
    <!--        <div class="col-md-4 col-lg-3 mb-3">-->
    <!--            <div class="card model-card">-->
    <!--                <div class="card-body">-->
    <!--                    <h2 class="card-title">ç‹®å­ç«™</h2>-->
    <!--                    <p class="card-text"></p>-->
    <!--                    <div class="d-flex justify-content-between">-->
    <!--                        <button class="btn btn-mini btn-primary" type="button">æŸ¥çœ‹</button>-->
    <!--                        <button class="btn btn-mini btn-danger" type="button">åˆ é™¤</button>-->
    <!--                    </div>-->
    <!--                </div>-->
    <!--            </div>-->
    <!--        </div>-->
    <!--    </div>-->
    <div class="row" id="stations-row" style="margin: 0 3rem;">
        <!-- ç«™ç‚¹æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ -->
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">ç¼–è¾‘</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- ç¼–è¾‘è¡¨å• -->
                    <form id="editForm">
                        <div class="form-group" style="display:none;">
                            <label for="id">id</label>
                            <input type="text" class="form-control" id="id" placeholder="">
                        </div>
                        <div class="form-group" style="display:none;">
                            <label for="createTime">createTime</label>
                            <input type="text" class="form-control" id="createTime" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="name">çº¿è·¯åç§°</label>
                            <input type="text" class="form-control" id="name" placeholder="è¯·è¾“å…¥çº¿è·¯åç§°">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="submitModify()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function changeContent(id) {
        var contents = document.querySelectorAll('#content > div');
        contents.forEach(function(content) {
            content.style.display = 'none';
        });
        document.getElementById(id).style.display = 'block';
    }

    function deleteLine (lineId) {
        // å‘é€è¯·æ±‚
        $.ajax({
            url: '/ebutler/line/del?ids='+lineId,
            type: 'POST',
            contentType: 'application/json; charset=utf-8', // è®¾ç½®æ­£ç¡®çš„Content-Type
            dataType: 'json', // é¢„æœŸä»æœåŠ¡å™¨æ¥æ”¶çš„å“åº”ç±»å‹
            success: function(response) {
                if (!checkRsp(response)) {
                    return;
                }
                loadStations();
            },
            error: function(error) {
                console.error('Error occurred:', error);
                alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•');
            }
        });
    }

    function checkRsp(rsp) {
        if (!rsp.success) {
            if (rsp.code == '400') {
                alert(rsp.message);
                return false;
            }
            alert('system error');
            return false;
        }
        return true;
    }

    function loadStations(siteId) {
        if (isNullOrEmpty(siteId)) {
            siteId = "";
        }
        $.ajax({
            url: '/ebutler/allLine?siteId='+siteId, // æ›¿æ¢ä¸ºä½ çš„åç«¯APIåœ°å€
            method: 'GET',
            success: function(rsp) {
                if (!checkRsp(rsp)) {
                    return;
                }
                // æ¸…ç©ºç°æœ‰çš„ç«™ç‚¹æ•°æ®
                $('#stations-row').empty();

                // éå†æ•°æ®å¹¶åŠ¨æ€æ’å…¥ç«™ç‚¹å¡ç‰‡
                list = rsp.data;
                siteList = list;
                list.forEach(station => {
                    const jsonString = JSON.stringify(station);
                    // å°† JSON å­—ç¬¦ä¸²è½¬æ¢ä¸º UTF-8 æ ¼å¼çš„ Uint8Array
                    const encoder = new TextEncoder();
                    const uint8Array = encoder.encode(jsonString);

                    // å°† Uint8Array è½¬æ¢ä¸º Base64 å­—ç¬¦ä¸²
                    const base64String = btoa(String.fromCharCode.apply(null, uint8Array));
                    const cardHtml = `
                <div class="col-md-6 col-lg-6 mb-6">
                  <div class="card model-card">
                    <div class="card-body">
                      <h4 class="card-title">${station.name}</h4>
                      <div class="d-flex justify-content-between">
                        <button class="btn btn-mini btn-primary" type="button" onclick="location.href='index.html?search=çº¿è·¯:${station.name}'">æŸ¥çœ‹å®¢æˆ·</button>
                        <button class="btn btn-mini btn-default" type="button" onclick="showModify('${base64String}')">ä¿®æ”¹</button>
                        <button class="btn btn-mini btn-danger" type="button" onclick="deleteLine(${station.id})">åˆ é™¤</button>
                      </div>
                    </div>
                  </div>
                </div>
              `;
                    $('#stations-row').append(cardHtml);
                });
            },
            error: function(error) {
                console.error('Error fetching stations:', error);
            }
        });
    }

    function isNullOrEmpty(value) {
        return value === null || value === undefined || value === '';
    }

    function showModify(base64String) {
        if (isNullOrEmpty(base64String)) {
            $('#id').val(null);
            $('#name').val(null);
            $('#createTime').val(null);
            $('#editModal').modal('show');
            return;
        }

        // å°† Base64 å­—ç¬¦ä¸²è½¬æ¢ä¸º UTF-8 æ ¼å¼çš„ Uint8Array
        const binaryString = atob(base64String);
        const uint8Array = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            uint8Array[i] = binaryString.charCodeAt(i);
        }

        // å°† Uint8Array è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
        const decoder = new TextDecoder();
        const jsonString = decoder.decode(uint8Array);

        // å°† JSON å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡
        const site = JSON.parse(jsonString);
        // å¡«å……è¾“å…¥æ¡†æ•°æ®
        $('#id').val(site.id);
        $('#name').val(site.name);
        $('#createTime').val(site.createTime);
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        $('#editModal').modal('show');
    }

    function submitModify(){
        $('#editModal').modal('hide');

        var formData = {
            id: $('#id').val(),
            siteId: getQueryParams(),
            createTime: $('#createTime').val(),
            name: $('#name').val()
        }
        // å‘é€è¯·æ±‚
        $.ajax({
            url: '/ebutler/line/upsert',
            type: 'POST',
            contentType: 'application/json; charset=utf-8', // è®¾ç½®æ­£ç¡®çš„Content-Type
            dataType: 'json', // é¢„æœŸä»æœåŠ¡å™¨æ¥æ”¶çš„å“åº”ç±»å‹
            data: JSON.stringify(formData), // å°†æ•°æ®åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²
            success: function(response) {
                if (!checkRsp(response)) {
                    return;
                }
                loadStations(getQueryParams());
            },
            error: function(error) {
                console.error('Error occurred:', error);
                alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•');
            }
        });
    }

    // ä» URL ä¸­æå–æŸ¥è¯¢å‚æ•°
    function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return params.get('siteId');
    }

    $(document).ready(function() {

        // è·å–æŸ¥è¯¢å‚æ•°
        const siteId = getQueryParams();

        // è°ƒç”¨å‡½æ•°åŠ è½½ç«™ç‚¹æ•°æ®
        loadStations(siteId);

        // ç›‘å¬è¾“å…¥æ¡†çš„å›è½¦é”®äº‹ä»¶
        $('#search').on('keypress', function(event) {
            if (event.which === 13) { // 13 æ˜¯å›è½¦é”®çš„é”®ç 
                performSearch();
            }
        });

        function performSearch() {
            const search = $('#search').val().trim();
            if (siteId) {
                // æ„å»ºç›®æ ‡ URL
                const url = `/static/index.html?search=${encodeURIComponent(siteId)}`;
                // è·³è½¬åˆ°æ–°é¡µé¢
                // åœ¨æ–°çª—å£æˆ–æ ‡ç­¾é¡µä¸­æ‰“å¼€ç›®æ ‡ URL
                window.open(url, '_blank');
            } else {
                alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
            }
        }
    });

    $(function () {
        $('#table').bootstrapTable({
            url: '/ebutler/page', // åç«¯APIåœ°å€
            toolbar: '#toolbar', // å·¥å…·æ é€‰æ‹©å™¨
            method: 'get', // ä½¿ç”¨ get è¯·æ±‚
            pagination: true, // æ˜¾ç¤ºåˆ†é¡µ
            pageSize: 10, // æ¯é¡µæ˜¾ç¤ºè®°å½•æ•°
            pageList: [10, 25, 50, 100], // åˆ†é¡µé€‰é¡¹
            sidePagination: 'server', // ä½¿ç”¨æœåŠ¡å™¨ç«¯åˆ†é¡µ
            queryParams: queryParams, // è‡ªå®šä¹‰è¯·æ±‚å‚æ•°
            search: true,
            showRefresh: true,
            showToggle: true,
            showColumns: true,
            searchOnEnterKey: true
        });

        function queryParams(params) {
            return {
                limit: params.limit, // é¡µé¢å¤§å°
                offset: params.offset, // èµ·å§‹ä½ç½®
                sort: params.sortName, // æ’åºå­—æ®µ
                order: params.sortOrder, // æ’åºæ–¹å¼
                search: params.search // æœç´¢å…³é”®è¯
            };
        }

        // å½“ç‚¹å‡»æ·»åŠ æŒ‰é’®æ—¶è§¦å‘æ¨¡æ€æ¡†
        $('#btn_add').click(function() {
            $('#editModal').modal('show');
        });
    });
</script>

</body>
</html>